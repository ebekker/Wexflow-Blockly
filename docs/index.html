<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Wexflow Graphical Editor</title>
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-102948379-1', 'auto');
        ga('send', 'pageview');
    </script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            background-color: #fff;
            font-family: sans-serif;
            overflow: hidden;
        }

        h1 {
            font-weight: normal;
            font-size: 140%;
        }

        table {
            height: 100%;
            width: 100%;
        }

        #blocklyArea {
            height: 99%;
            width: 99%;
            background: #fc9;
            text-align: center;
        }
    </style>
    <script src="blockly_compressed.js"></script>
    <script src="generators/wexflow.js"></script>
    <script src="blocks_compressed.js"></script>
    <script src="msg/js/en.js"></script>
    <script src="wexflow_blocks.js"></script>
    <script src="storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script>
</head>

<body>
    <table>
        <tr>
            <td><!-- top-left --></td>
            <td>
                <xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
                    <category name="Workflow">
                      <block type="wexflow_workflow"></block>
                      <block type="wexflow_workflow_setting">
                        <field name="NAME">name</field>
                        <field name="VALUE">default</field>
                      </block>
                      <block type="wexflow_events"></block>
                      <label text="Generic Task"></label>
                      <block type="wexflow_task">
                        <field name="NAME">name</field>
                        <field name="ENABLED">TRUE</field>
                        <field name="DESCRIPTION"></field>
                      </block>
                      <block type="wexflow_task_setting">
                        <field name="NAME">name</field>
                        <field name="VALUE">default</field>
                      </block>
                    </category>
                    <sep></sep>
                    <category name="Flowchart">
                      <block type="wexflow_graph_if">
                        <value name="IF">
                          <block type="wexflow_task_single">
                            <field name="NAME">name</field>
                            <field name="ENABLED">TRUE</field>
                            <field name="DESCRIPTION"></field>
                          </block>
                        </value>
                      </block>
                      <block type="wexflow_graph_while">
                        <value name="WHILE">
                          <block type="wexflow_task_single">
                            <field name="NAME">name</field>
                            <field name="ENABLED">TRUE</field>
                            <field name="DESCRIPTION"></field>
                          </block>
                        </value>
                      </block>
                      <block type="wexflow_graph_switch">
                        <value name="SWITCH">
                          <block type="wexflow_task_single">
                            <field name="NAME">name</field>
                            <field name="ENABLED">TRUE</field>
                            <field name="DESCRIPTION"></field>
                          </block>
                        </value>
                        <statement name="CASES">
                          <block type="wexflow_graph_switch_case">
                            <field name="VALUE">value</field>
                          </block>
                        </statement>
                      </block>
                      <block type="wexflow_graph_switch_case">
                        <field name="VALUE">value</field>
                      </block>
                      <label text="Single Generic Task"></label>
                      <block type="wexflow_task_single">
                        <field name="NAME">name</field>
                        <field name="ENABLED">TRUE</field>
                        <field name="DESCRIPTION"></field>
                      </block>
                    </category>
                    <sep></sep>
                    <category name="Misc">
                        <block type="wexflow_diagram_text_single"></block>
                        <block type="wexflow_diagram_text_group"></block>
                        <block type="wexflow_diagram_text_multi"></block>
                    </category>
                    <sep></sep>
                </xml>
                  <!-- <xml id="toolbox" style="display: none">
                    <category name="Logic" expanded="true">
                        <block type="controls_if"></block>
                        <block type="controls_repeat_ext"></block>
                        <block type="logic_compare"></block>
                    </category>
                    <category name="Misc" expanded="true">
                        <block type="math_number"></block>
                        <block type="math_arithmetic"></block>
                        <block type="text"></block>
                        <block type="text_print"></block>
                    </category>
                </xml> -->
            </td>
            <td><!--top-right--></td>
        </tr>
        <tr>
            <td><!--mid-left--></td>
            <td id="blocklyArea"><!--Blockly will be positioned here--></td>
            <td>
                <!-- Clipboard access is a bit harder than it should be -->
                <!--
                Clipboard:
                <div><button onclick="copyCode()" data-clipboard-target="#copy_code">Copy Diagram</button></div>
                <div><button onclick="pasteCode()">Paste Diagram</button></div>
                <textarea id="copy_code" style="display:none;"></textarea>
                <div>&nbsp;</div>
                -->
                File:
                <div><button onclick="saveCode()">Save Diagram</button></div>
                <div><button onclick="loadCode()">Load Diagram</button></div>
                <div>&nbsp;</div>
                <div><button onclick="exportCode()">Export Workflow</button></div>
                <input type="file" id="load_file" accept=".diagram.xml" onchange="handleFiles(this.files)" style="display:none;"></input>
                <div>&nbsp;</div>
                <a href="javascript:openSamples()">Samples</a>
                <div>&nbsp;</div>
                <div><button onclick="clearCode()">Cleark Workspace</button></div>
            </td>
        </tr>
        <tr>
            <td><!--bottom-left  --></td>
            <td><!--bottom-center--></td>
            <td>
                <div><button onclick="generateCode()">Generate</button></div>
            </td>
        </tr>
    </table>

    <script>
        var mainWorkspace = Blockly.inject('blocklyArea', {
            toolbox: document.getElementById('toolbox'),
            trashcan: true,
            grid: {
                spacing: 20,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            collapse: true,
            comments: true,
            disable: true,
            scrollbars: true,
            zoom: {
                controls: true,
                wheel: false, // found true to be annoying since we usually want the wheel to move up or down
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            oneBasedIndex: false,
            readOnly: false

            // collapse:	boolean	Allows blocks to be collapsed or expanded. Defaults to true if the toolbox has categories, false otherwise.
            // comments:	boolean	Allows blocks to have comments. Defaults to true if the toolbox has categories, false otherwise.
            // css:	boolean	If false, don't inject CSS (providing CSS becomes the document's responsibility). Defaults to true.
            // disable:	boolean	Allows blocks to be disabled. Defaults to true if the toolbox has categories, false otherwise.
            // grid:	object	Configures a grid which blocks may snap to. See Grid...
            // horizontalLayout:	boolean	If true toolbox is horizontal, if false toolbox is vertical. Defaults to false.
            // maxBlocks:	number	Maximum number of blocks that may be created. Useful for student exercises. Defaults to Infinity.
            // media:	string	Path from page (or frame) to the Blockly media directory. Defaults to "https://blockly-demo.appspot.com/static/media/".
            // oneBasedIndex:	boolean	If true list and string operations should index from 1, if false index from 0. Defaults to true.
            // readOnly:	boolean	If true, prevent the user from editing. Supresses the toolbox and trashcan. Defaults to false.
            // rtl:	boolean	If true, mirror the editor (for Arabic or Hebrew locales). See RTL demo. Defaults to false.
            // scrollbars:	boolean	Sets whether the workspace is scrollable or not. Defaults to true if the toolbox has categories, false otherwise.
            // sounds:	boolean	If false, don't play sounds (e.g. click and delete). Defaults to true.
            // toolbox:	XML nodes or string	Tree structure of categories and blocks available to the user. See below for more information.
            // toolboxPosition:	string	If "start" toolbox is on top (if horizontal) or left (if vertical and LTR) or right (if vertical and RTL). If "end" toolbox is on opposite side. Defaults to "start".
            // trashcan:	boolean	Displays or hides the trashcan. Defaults to true if the toolbox has categories, false otherwise.
            // zoom:	object	Configures zooming behaviour. See Zoom...
        });
        // Makes sure orphans can't *float* on the page
        mainWorkspace.addChangeListener(Blockly.Events.disableOrphans);

        if ('BlocklyStorage' in window) {
            BlocklyStorage.HTTPREQUEST_ERROR = 'There was a problem with the request.\n';
            BlocklyStorage.LINK_ALERT = 'Share your blocks with this link:\n\n%1';
            BlocklyStorage.HASH_ERROR = 'Sorry, "%1" doesn\'t correspond with any saved Blockly file.';
            BlocklyStorage.XML_ERROR = 'Could not load your saved file.\n' +
                'Perhaps it was created with a different version of Blockly?';

                // Reload the last blockly workspace
            window.setTimeout(BlocklyStorage.restoreBlocks, 0);
            // Save the workspace upon leaving
            BlocklyStorage.backupOnUnload();
        }

        //var rootBlock = '<xml><block type="wexflow_workflow" deletable="false" movable="false"></block></xml>';
        //Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(rootBlock), workspace);

        function generateCode() {
            console.log("Generating...");
            var code = Blockly.Wexflow.workspaceToCode(mainWorkspace);
            console.log("Generated: " + code);
        }
        function copyCode() {
            var xml = Blockly.Xml.workspaceToDom(mainWorkspace);
            // Ugly:
            //var xml_text = Blockly.Xml.domToText(xml);
            // Pretty:
            var xml_text = Blockly.Xml.domToPrettyText(xml);
            
            download('wexflow.diagram.xml', xml_text);
        }
        function saveCode() {
            var xml = Blockly.Xml.workspaceToDom(mainWorkspace);
            // Ugly:
            //var xml_text = Blockly.Xml.domToText(xml);
            // Pretty:
            var xml_text = Blockly.Xml.domToPrettyText(xml);
            download('wexflow.diagram.xml', xml_text);
        }
        function loadCode() {
            document.getElementById('load_file').click();
        }
        function exportCode() {
            var code = Blockly.Wexflow.workspaceToCode(mainWorkspace);
            download('wexflow.workflow.xml', code);
        }
        function clearCode() {
            mainWorkspace.clear();
        }

        // From:  https://stackoverflow.com/a/18197341/5428506
        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        // From:  https://www.html5rocks.com/en/tutorials/file/dndfiles/
        //  and:  https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications
        function handleFiles(files) {
            for (var i = 0, f; f = files[i]; i++) {
                var reader = new FileReader();

                reader.onload = (function(theFile) {
                    return function(e) {
                        var xml = Blockly.Xml.textToDom(e.target.result);
                        Blockly.Xml.domToWorkspace(xml, mainWorkspace);
                    };
                })(f);

                reader.readAsText(f);
                break;
            }
        }

        function openSamples() {
            var openSamplesWin = window.open('samples.html', 'open_samples', 'width=400,height=300', true)
        }
        function openSample(name) {
            var theUrl = 'samples/' + name;
            xmlhttp=new XMLHttpRequest();
            xmlhttp.onreadystatechange=function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var xml = Blockly.Xml.textToDom(xmlhttp.responseText);
                    Blockly.Xml.domToWorkspace(xml, mainWorkspace);
                }
            }
            xmlhttp.open("GET", theUrl, false );
            xmlhttp.send();
        }
        window.addEventListener('message', function(event) {
            var prefix = 'openSample:';
            var eventData = event.data;
            if (eventData.startsWith(prefix)) {
                var name = eventData.substr(prefix.length);
                openSample(name);
            }
        });
    </script>

</body>

</html>